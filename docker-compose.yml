# docker-compose.yml

services:
  # Service 1: Data fetching - retrieves data from Fiindo API
  step1-fetch:
    working_dir: /app/src  # Working directory inside container
    build: .  # Build image from current directory's Dockerfile
    container_name: fiindo-step1  # Custom container name
    command: python step1_fetch.py  # Command to execute
    volumes:
      # Mount local ./data directory to /app/data in container
      - ./data:/app/data
      # Mount local ./logs directory for log persistence
      - ./logs:/app/logs
    environment:
      # Environment variables for authentication
      FIRST_NAME: ${FIRST_NAME}
      LAST_NAME: ${LAST_NAME}
      # Enable unbuffered Python output for immediate log visibility
      PYTHONUNBUFFERED: 1
    env_file:
      # Load environment variables from .env file
      - .env

  # Service 2: Data transformation - processes raw data
  step2-transform:
    working_dir: /app/src
    build: .
    container_name: fiindo-step2
    command: python step2_transform.py
    volumes:
      # Share same data volume as step1-fetch
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    depends_on:
      # Ensure step1 completes before starting step2
      - step1-fetch

  # Service 3: Database loading - stores data in SQLite database
  step3-load:
    working_dir: /app/src
    build: .
    container_name: fiindo-step3
    command: python step3_load.py
    volumes:
      - ./data:/app/data
      # Mount local ./db directory for database persistence
      - ./db:/app/db
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    depends_on:
      # Ensure step2 completes before starting step3
      - step2-transform

  # Service 4: Database checking - verifies and displays database content
  check-db:
    working_dir: /app/src
    build: .
    container_name: fiindo-check
    command: python check_database.py
    volumes:
      # Access database created by step3-load
      - ./db:/app/db
    depends_on:
      # Ensure database exists before checking
      - step3-load